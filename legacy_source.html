<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mini Life World - Creative Play</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- CORE ENGINE STYLES --- */
        body {
            overscroll-behavior: none;
            touch-action: none;
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: #222;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background-color: #fff;
            overflow: hidden;
        }

        /* --- ROOM STYLES (WALLS & FLOORS) --- */
        .scene {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            pointer-events: none;
        }

        .wall { flex: 1; position: relative; width: 100%; z-index: 1; pointer-events: auto; }
        .floor {
            height: 180px; width: 100%; position: relative; z-index: 2;
            box-shadow: inset 0 10px 20px rgba(0,0,0,0.1); pointer-events: auto;
        }

        /* Living Room Theme */
        .livingroom-wall { background-color: #FFE5D9; background-image: repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(255,255,255,0.5) 40px, rgba(255,255,255,0.5) 80px); }
        .livingroom-floor { background-color: #D4A373; background-image: linear-gradient(90deg, rgba(0,0,0,0.05) 2px, transparent 2px), linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px); background-size: 100px 100%, 100% 20px; }

        /* Kitchen Theme */
        .kitchen-wall { background-color: #E0FBFC; background-image: linear-gradient(#98c1d9 1px, transparent 1px), linear-gradient(90deg, #98c1d9 1px, transparent 1px); background-size: 40px 40px; }
        .kitchen-floor { background-color: #3D5A80; background-image: linear-gradient(45deg, #293241 25%, transparent 25%, transparent 75%, #293241 75%, #293241), linear-gradient(45deg, #293241 25%, transparent 25%, transparent 75%, #293241 75%, #293241); background-size: 60px 60px; background-position: 0 0, 30px 30px; }

        /* Bathroom Theme */
        .bathroom-wall { background-color: #CDB4DB; background-image: radial-gradient(#FFC8DD 20%, transparent 20%); background-size: 30px 30px; }
        .bathroom-floor { background-color: #A2D2FF; background-image: linear-gradient(30deg, #BDE0FE 12%, transparent 12.5%, transparent 87%, #BDE0FE 87.5%, #BDE0FE), linear-gradient(150deg, #BDE0FE 12%, transparent 12.5%, transparent 87%, #BDE0FE 87.5%, #BDE0FE), linear-gradient(30deg, #BDE0FE 12%, transparent 12.5%, transparent 87%, #BDE0FE 87.5%, #BDE0FE), linear-gradient(150deg, #BDE0FE 12%, transparent 12.5%, transparent 87%, #BDE0FE 87.5%, #BDE0FE), radial-gradient(#BDE0FE 20%, transparent 20%); background-size: 80px 140px; }

        /* --- LAYERS CONTAINER --- */
        #objectsLayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* --- OBJECTS --- */
        .game-obj {
            position: absolute; cursor: grab; user-select: none; touch-action: none;
            transition: transform 0.1s; display: flex; align-items: center; justify-content: center;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15)); pointer-events: auto;
        }
        .game-obj:active { cursor: grabbing; transform: scale(1.05) !important; z-index: 100 !important; }

        /* Types & Sizes */
        .type-furniture { z-index: 10; }
        .type-furniture-back { z-index: 5; }
        .type-item { z-index: 20; width: 50px; height: 50px; font-size: 40px; }
        .type-character { z-index: 30; width: 90px; height: 140px; }
        .type-wearable { z-index: 35; width: 50px; height: 50px; font-size: 35px; }
        
        /* Fridge */
        .fridge-group { perspective: 800px; }
        .fridge-door { transform-origin: left; transition: transform 0.4s ease-in-out; }
        .fridge-open .fridge-door { transform: rotateY(-110deg); }

        /* --- UI ELEMENTS --- */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 200; }

        .nav-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); padding: 8px 16px; border-radius: 24px;
            display: flex; gap: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); pointer-events: auto;
            border: 4px solid #fff; z-index: 210;
        }

        .nav-btn {
            width: 50px; height: 50px; border-radius: 16px; border: none;
            background: #f0f0f0; cursor: pointer; font-size: 24px; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .nav-btn:hover, .nav-btn.active { background: #FFD6E0; transform: translateY(-3px); box-shadow: 0 4px 0 #FF9A9E; }

        /* Catalog Modal */
        .catalog-modal {
            position: absolute; bottom: -100%; left: 0; width: 100%; height: 70vh;
            background: #fff; border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
            transition: bottom 0.3s ease-in-out; pointer-events: auto;
            display: flex; flex-direction: column; z-index: 300;
        }
        .catalog-modal.open { bottom: 0; }
        .catalog-header { padding: 15px; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .catalog-tabs { display: flex; gap: 10px; padding: 10px; overflow-x: auto; background: #fafafa; }
        .tab-btn {
            padding: 8px 16px; border-radius: 20px; background: #fff; border: 1px solid #ddd;
            font-weight: bold; font-size: 14px; white-space: nowrap; cursor: pointer;
        }
        .tab-btn.active { background: #FF9A9E; color: white; border-color: #FF9A9E; }
        
        .catalog-grid {
            flex: 1; overflow-y: auto; padding: 20px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;
        }
        .catalog-item {
            aspect-ratio: 1; background: #f8f8f8; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent; transition: all 0.2s;
            position: relative;
        }
        .catalog-item:hover { border-color: #FF9A9E; transform: scale(1.05); background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .catalog-item svg, .catalog-item div { max-width: 80%; max-height: 80%; pointer-events: none; }

        /* Other UI */
        .light-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(12, 12, 40, 0.6); pointer-events: none; z-index: 90; opacity: 0; transition: opacity 0.5s; }
        .wall-switch { position: absolute; top: 40%; right: 10px; width: 30px; height: 50px; background: #eee; border-radius: 4px; border: 1px solid #ccc; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); cursor: pointer; pointer-events: auto; z-index: 15; display: flex; justify-content: center; align-items: center; }
        .wall-switch-knob { width: 10px; height: 20px; background: #fff; border: 1px solid #bbb; transition: transform 0.2s; }
        
        .save-toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; opacity: 0; transition: opacity 0.5s; z-index: 400; }
        
        /* Scenario & Thoughts */
        .scenario-box { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: #fff; border: 3px solid #7209B7; border-radius: 20px; padding: 15px; z-index: 250; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; animation: pop 0.3s ease-out; text-align: center; }
        .speech-bubble { position: absolute; background: white; border-radius: 18px; padding: 12px 18px; border: 3px solid #333; z-index: 300; max-width: 200px; box-shadow: 4px 4px 0px rgba(0,0,0,0.15); font-size: 14px; font-weight: bold; color: #333; text-align: center; pointer-events: none; animation: pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .speech-bubble::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid #333; }
        
        @keyframes pop { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .reaction-emoji { position: absolute; font-size: 50px; animation: pop 1s forwards; z-index: 200; pointer-events: none; }

    </style>
</head>
<body>

<div class="game-container" id="gameContainer">
    <!-- BACKGROUND -->
    <div id="sceneBackground"></div>
    
    <!-- OBJECTS LAYER -->
    <div id="objectsLayer"></div>

    <!-- UI LAYER -->
    <div class="ui-layer">
        <!-- Header -->
        <div class="absolute top-4 left-4 flex gap-3 pointer-events-auto">
             <div class="bg-white px-4 py-2 rounded-full shadow border-2 border-gray-100 font-bold text-gray-700 flex items-center gap-2 select-none">
                <span>üè† Mini Life</span>
            </div>
            <button onclick="generateScenario()" id="btnScenario" class="bg-purple-100 hover:bg-purple-200 text-purple-700 border-2 border-purple-200 px-3 py-2 rounded-full font-bold text-sm flex items-center gap-1 transition-transform active:scale-95 shadow-sm">
                <span>‚ú® Story</span>
            </button>
            <button onclick="generateThoughts()" id="btnThoughts" class="bg-orange-100 hover:bg-orange-200 text-orange-700 border-2 border-orange-200 px-3 py-2 rounded-full font-bold text-sm flex items-center gap-1 transition-transform active:scale-95 shadow-sm">
                <span>üí≠ Think</span>
            </button>
        </div>

        <div id="saveToast" class="save-toast">Game Saved</div>
        <div id="scenarioBox" class="scenario-box pointer-events-auto">
            <h3 class="text-xs font-black text-purple-600 uppercase tracking-widest mb-2">Creative Prompt</h3>
            <p id="scenarioText" class="text-gray-800 font-bold text-lg leading-tight mb-3">...</p>
            <button onclick="document.getElementById('scenarioBox').style.display='none'" class="bg-gray-100 hover:bg-gray-200 px-4 py-1 rounded-full text-sm font-bold text-gray-600">Got it!</button>
        </div>

        <!-- Catalog Toggle -->
        <button onclick="toggleCatalog()" class="absolute bottom-24 right-4 bg-yellow-400 p-4 rounded-full shadow-lg border-4 border-white text-white hover:scale-110 transition pointer-events-auto z-50 flex items-center justify-center" title="Furniture Shop">
            <span class="text-2xl">üõçÔ∏è</span>
        </button>

        <!-- Reset -->
        <button onclick="resetGame()" class="absolute top-4 right-4 bg-white p-2 rounded-full shadow hover:bg-red-50 transition pointer-events-auto border-2 border-gray-100 text-gray-600">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74-2.74L3 12"/></svg>
        </button>

        <!-- Scene Nav -->
        <div class="nav-bar">
            <button class="nav-btn active" id="btn-livingroom" onclick="switchScene('livingroom')">üõãÔ∏è</button>
            <button class="nav-btn" id="btn-kitchen" onclick="switchScene('kitchen')">üç≥</button>
            <button class="nav-btn" id="btn-bathroom" onclick="switchScene('bathroom')">üõÅ</button>
        </div>
    </div>

    <!-- CATALOG MODAL -->
    <div id="catalogModal" class="catalog-modal">
        <div class="catalog-header">
            <h2 class="text-xl font-bold text-gray-800">Furniture Shop</h2>
            <button onclick="toggleCatalog()" class="text-gray-500 hover:text-red-500 font-bold text-xl px-2">‚úï</button>
        </div>
        <div class="catalog-tabs" id="catalogTabs">
            <!-- Injected via JS -->
        </div>
        <div class="catalog-grid" id="catalogGrid">
            <!-- Injected via JS -->
        </div>
    </div>
</div>

<script>
    /* --- SVG TEMPLATES & GENERATOR --- */
    const SVG_TEMPLATES = {
        chair: (c) => `<svg viewBox="0 0 100 150"><path d="M20 70 L20 140 M80 70 L80 140" stroke="#8D6E63" stroke-width="8"/><rect x="15" y="70" width="70" height="15" fill="${c}" rx="5"/><path d="M20 70 L20 10 Q20 0 30 0 L70 0 Q80 0 80 10 L80 70" fill="${c}" opacity="0.9"/></svg>`,
        armchair: (c) => `<svg viewBox="0 0 120 120"><path d="M20 60 L20 110 M100 60 L100 110" stroke="#5D4037" stroke-width="8"/><rect x="15" y="40" width="90" height="60" rx="10" fill="${c}"/><path d="M15 40 Q15 10 60 10 Q105 10 105 40" fill="${c}" filter="brightness(0.9)"/><rect x="10" y="50" width="20" height="40" rx="5" fill="${c}" filter="brightness(1.1)"/><rect x="90" y="50" width="20" height="40" rx="5" fill="${c}" filter="brightness(1.1)"/></svg>`,
        sofa: (c) => `<svg viewBox="0 0 200 120"><rect x="10" y="50" width="180" height="60" rx="10" fill="${c}"/><path d="M10 50 Q10 10 100 10 Q190 10 190 50" fill="${c}" filter="brightness(0.9)"/><rect x="5" y="60" width="30" height="40" rx="5" fill="${c}" filter="brightness(1.1)"/><rect x="165" y="60" width="30" height="40" rx="5" fill="${c}" filter="brightness(1.1)"/><circle cx="30" cy="110" r="5" fill="#5D4037"/><circle cx="170" cy="110" r="5" fill="#5D4037"/></svg>`,
        table_round: (c) => `<svg viewBox="0 0 120 100"><rect x="55" y="40" width="10" height="50" fill="#8D6E63"/><path d="M40 90 L80 90" stroke="#8D6E63" stroke-width="4"/><ellipse cx="60" cy="40" rx="55" ry="15" fill="${c}" stroke="#5D4037" stroke-width="2"/></svg>`,
        table_rect: (c) => `<svg viewBox="0 0 150 100"><rect x="20" y="30" width="110" height="15" fill="${c}"/><rect x="30" y="45" width="10" height="50" fill="#8D6E63"/><rect x="110" y="45" width="10" height="50" fill="#8D6E63"/></svg>`,
        cabinet: (c) => `<svg viewBox="0 0 100 150"><rect x="10" y="10" width="80" height="130" rx="2" fill="${c}" stroke="#555" stroke-width="2"/><line x1="10" y1="50" x2="90" y2="50" stroke="#555"/><line x1="10" y1="90" x2="90" y2="90" stroke="#555"/><circle cx="80" cy="30" r="3" fill="#333"/><circle cx="80" cy="70" r="3" fill="#333"/></svg>`,
        lamp_floor: (c) => `<svg viewBox="0 0 60 200"><rect x="28" y="180" width="4" height="20" fill="#333"/><rect x="20" y="190" width="20" height="5" fill="#333"/><line x1="30" y1="40" x2="30" y2="180" stroke="#333" stroke-width="2"/><path d="M10 40 L50 40 L45 10 L15 10 Z" fill="${c}" opacity="0.9"/></svg>`,
        lamp_table: (c) => `<svg viewBox="0 0 60 80"><rect x="28" y="40" width="4" height="30" fill="#333"/><rect x="20" y="70" width="20" height="5" fill="#333"/><path d="M10 40 L50 40 L40 10 L20 10 Z" fill="${c}" opacity="0.9"/></svg>`,
        plant: (c) => `<svg viewBox="0 0 80 120"><path d="M30 80 L50 80 L55 110 L25 110 Z" fill="#E76F51"/><path d="M40 80 Q20 20 40 10 Q60 20 40 80" fill="${c}"/><path d="M40 80 Q10 50 20 30" fill="${c}" opacity="0.8"/><path d="M40 80 Q70 50 60 30" fill="${c}" opacity="0.8"/></svg>`,
        rug_round: (c) => `<svg viewBox="0 0 120 60"><ellipse cx="60" cy="30" rx="55" ry="25" fill="${c}" opacity="0.8" stroke="white" stroke-width="2" stroke-dasharray="4 2"/></svg>`,
        rug_rect: (c) => `<svg viewBox="0 0 120 80"><rect x="10" y="10" width="100" height="60" rx="5" fill="${c}" opacity="0.8" stroke="white" stroke-width="2"/></svg>`,
        bed: (c) => `<svg viewBox="0 0 160 100"><rect x="10" y="40" width="140" height="50" rx="5" fill="white" stroke="#ccc"/><rect x="10" y="20" width="140" height="30" rx="5" fill="#8D6E63"/><rect x="20" y="30" width="40" height="20" fill="white" rx="5"/><rect x="20" y="50" width="120" height="40" rx="5" fill="${c}"/></svg>`,
        tv: (c) => `<svg viewBox="0 0 120 100"><rect x="10" y="10" width="100" height="70" rx="5" fill="#333"/><rect x="15" y="15" width="90" height="60" fill="#111"/><path d="M40 80 L80 80 L90 95 L30 95 Z" fill="#222"/></svg>`,
        computer: (c) => `<svg viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="60" rx="5" fill="#ddd"/><rect x="15" y="15" width="70" height="50" fill="#333"/><rect x="30" y="70" width="40" height="5" fill="#aaa"/><rect x="20" y="75" width="60" height="5" fill="#333"/></svg>`,
        fridge: (c) => `<svg viewBox="0 0 150 300"><rect x="10" y="10" width="130" height="280" rx="10" fill="${c}" stroke="#999" stroke-width="2"/><line x1="10" y1="100" x2="140" y2="100" stroke="#999"/><rect x="120" y="40" width="8" height="40" rx="2" fill="#fff"/><rect x="120" y="130" width="8" height="40" rx="2" fill="#fff"/></svg>`,
        bath_tub: (c) => `<svg viewBox="0 0 200 100"><path d="M10 30 Q10 90 40 95 L160 95 Q190 90 190 30 Z" fill="white" stroke="#ddd" stroke-width="2"/><path d="M20 35 Q100 35 180 35" fill="none" stroke="${c}" stroke-width="10" opacity="0.3"/></svg>`,
        toilet: (c) => `<svg viewBox="0 0 80 120"><rect x="15" y="60" width="50" height="40" rx="5" fill="white"/><rect x="20" y="20" width="40" height="40" rx="5" fill="white"/><rect x="15" y="60" width="50" height="8" fill="${c}" opacity="0.5"/><ellipse cx="40" cy="100" rx="20" ry="5" fill="#eee"/></svg>`,
        sink: (c) => `<svg viewBox="0 0 100 120"><rect x="25" y="60" width="50" height="60" fill="#ddd"/><rect x="10" y="40" width="80" height="20" rx="5" fill="white"/><path d="M50 40 L50 20 L70 30" stroke="#999" stroke-width="4" fill="none"/></svg>`,
        window: (c) => `<svg viewBox="0 0 150 120"><rect x="10" y="10" width="130" height="100" fill="#A2D2FF" stroke="white" stroke-width="6"/><line x1="75" y1="10" x2="75" y2="110" stroke="white" stroke-width="6"/><line x1="10" y1="60" x2="140" y2="60" stroke="white" stroke-width="6"/></svg>`,
        shelf: (c) => `<svg viewBox="0 0 150 40"><rect x="0" y="0" width="150" height="10" rx="2" fill="${c}"/><rect x="20" y="10" width="5" height="20" fill="#999"/><rect x="125" y="10" width="5" height="20" fill="#999"/></svg>`
    };

    /* --- CATALOG DATA GENERATOR --- */
    const COLORS = {
        wood: ['#8D6E63', '#6D4C41', '#A1887F', '#D7CCC8'],
        fabric: ['#FF9A9E', '#A1C4FD', '#C1E1C1', '#FDFD96', '#B39EB5', '#FFB347', '#FF6961'],
        plant: ['#2A9D8F', '#264653', '#8AB17D'],
        neutral: ['#FFFFFF', '#E0E0E0', '#333333']
    };

    const CATALOG = {
        'Seating': [],
        'Tables': [],
        'Storage': [],
        'Bed & Bath': [],
        'Decor': [],
        'Electronics': [],
        'Plants': []
    };

    // Helper to add items
    function addItem(cat, name, template, colors, type='furniture', w=null, h=null) {
        colors.forEach((col, idx) => {
            CATALOG[cat].push({
                name: `${name} ${idx+1}`,
                svgTemplate: template,
                color: col,
                type: type,
                w: w, h: h,
                svg: SVG_TEMPLATES[template](col) // Pre-render for catalog
            });
        });
    }

    // --- POPULATE CATALOG (100+ Items) ---
    // Seating
    addItem('Seating', 'Simple Chair', 'chair', COLORS.wood.concat(COLORS.fabric), 'furniture', 60, 90);
    addItem('Seating', 'Comfy Armchair', 'armchair', COLORS.fabric, 'furniture', 100, 100);
    addItem('Seating', 'Modern Sofa', 'sofa', COLORS.fabric, 'furniture', 200, 120);

    // Tables
    addItem('Tables', 'Round Table', 'table_round', COLORS.wood.concat(['#fff']), 'furniture', 120, 100);
    addItem('Tables', 'Dining Table', 'table_rect', COLORS.wood, 'furniture', 150, 100);
    
    // Storage
    addItem('Storage', 'Tall Cabinet', 'cabinet', COLORS.wood.concat(COLORS.fabric), 'furniture', 80, 130);
    addItem('Storage', 'Wall Shelf', 'shelf', COLORS.wood.concat(['#fff', '#333']), 'furniture-wall', 150, 40);
    addItem('Storage', 'Fridge', 'fridge', ['#eee', '#333', '#FF9A9E', '#A1C4FD'], 'furniture-complex', 150, 300);

    // Bed & Bath
    addItem('Bed & Bath', 'Cozy Bed', 'bed', COLORS.fabric, 'furniture', 160, 100);
    addItem('Bed & Bath', 'Bathtub', 'bath_tub', ['#CDEFFF', '#FFC8DD', '#E0FBFC'], 'furniture', 200, 100);
    addItem('Bed & Bath', 'Toilet', 'toilet', ['#fff', '#f0f0f0'], 'furniture', 60, 100);
    addItem('Bed & Bath', 'Sink', 'sink', ['#fff'], 'furniture', 100, 120);

    // Electronics
    addItem('Electronics', 'Flat TV', 'tv', ['#333'], 'furniture', 120, 100);
    addItem('Electronics', 'PC Setup', 'computer', ['#333', '#fff'], 'furniture', 100, 100);
    addItem('Electronics', 'Table Lamp', 'lamp_table', COLORS.fabric, 'furniture', 40, 60);
    addItem('Electronics', 'Floor Lamp', 'lamp_floor', COLORS.fabric, 'furniture', 40, 150);

    // Plants
    addItem('Plants', 'Potted Plant', 'plant', COLORS.plant, 'furniture', 60, 100);

    // Decor (Rugs, Windows)
    addItem('Decor', 'Round Rug', 'rug_round', COLORS.fabric, 'furniture-back', 120, 60);
    addItem('Decor', 'Rect Rug', 'rug_rect', COLORS.fabric, 'furniture-back', 120, 80);
    addItem('Decor', 'Window', 'window', ['#fff'], 'furniture-wall', 150, 120);

    // Add EMOJI Items to generic categories to boost count
    const EMOJIS = {
        'Decor': ['üß∏','üéÅ','‚è∞','üìö','üé®','üñºÔ∏è','üïØÔ∏è','üè∫','üéà'],
        'Electronics': ['üìª','üì∑','üìû','‚è∞','üìπ','üéÆ'],
        'Plants': ['üåµ','üå≤','üíê','üåª','ü™¥'],
        'Kitchen': ['üçï','üçî','üçü','üå≠','üçø','ü•û','ü•ê','ü•Ø','üçû','üßÄ','ü•ó','ü•™','üåÆ','üåØ','üçú','üçù','üç©','üç™','üéÇ','üç∞','üßÅ','ü•ß','üç´','üç¨','üç≠','üçÆ','üçØ','üçº','ü•õ','‚òï','ü´ñ','üçµ','üßÉ','ü•§','üç≥','ü•ò','üç≤','ü•£']
    };
    
    for (let cat in EMOJIS) {
        EMOJIS[cat].forEach(e => {
            CATALOG[cat].push({
                name: 'Item',
                emoji: e,
                type: cat === 'Kitchen' ? 'food' : 'item',
                svg: `<div style="font-size:40px">${e}</div>`
            });
        });
    }


    /* --- GAME ENGINE --- */
    const GAME_WIDTH = window.innerWidth;
    const GAME_HEIGHT = window.innerHeight;
    const FLOOR_Y = GAME_HEIGHT - 180;
    const STORAGE_KEY = 'miniLifeWorld_v5';
    const API_KEY = ""; 

    /* Initial State */
    let state = loadState() || {
        currentScene: 'livingroom',
        items: [], // Start empty or use default? Let's give a starter pack
        isLightOn: true,
        fridgeOpen: false
    };

    if (state.items.length === 0) {
        // Starter Pack
        const starter = [
             { id: 'sofa_start', type: 'furniture', svgTemplate: 'sofa', color: '#FF9A9E', x: GAME_WIDTH/2 - 100, y: FLOOR_Y - 80, scene: 'livingroom', w: 200, h: 120 },
             { id: 'girl', type: 'character', svg: 'char_girl', x: 200, y: FLOOR_Y - 50, scene: 'livingroom' },
             { id: 'plant_start', type: 'furniture', svgTemplate: 'plant', color: '#2A9D8F', x: 50, y: FLOOR_Y - 50, scene: 'livingroom', w: 60, h: 100 }
        ];
        state.items = starter;
    }

    const ASSETS_CHAR = {
        char_girl: `<svg viewBox="0 0 100 150" class="drop-shadow-lg"><g transform="translate(5,5)"><path d="M30 140 L30 90 L70 90 L70 140" stroke="#333" stroke-width="12" stroke-linecap="round" fill="none"/><rect x="20" y="50" width="60" height="50" rx="10" fill="#FF9A9E"/><circle cx="50" cy="35" r="25" fill="#f8d5c2"/><path d="M25 35 Q50 5 75 35" fill="none" stroke="#5D4037" stroke-width="6" stroke-linecap="round"/><circle cx="42" cy="32" r="3" fill="#333"/><circle cx="58" cy="32" r="3" fill="#333"/><path d="M45 45 Q50 48 55 45" stroke="#333" stroke-width="2" fill="none"/><path d="M15 55 L25 80" stroke="#f8d5c2" stroke-width="8" stroke-linecap="round"/><path d="M85 55 L75 80" stroke="#f8d5c2" stroke-width="8" stroke-linecap="round"/></g></svg>`,
        char_boy: `<svg viewBox="0 0 100 150" class="drop-shadow-lg"><g transform="translate(5,5)"><path d="M30 140 L30 90 L70 90 L70 140" stroke="#333" stroke-width="12" stroke-linecap="round" fill="none"/><rect x="20" y="50" width="60" height="50" rx="10" fill="#A1C4FD"/><circle cx="50" cy="35" r="25" fill="#E0AC69"/><path d="M25 25 Q50 15 75 25" fill="none" stroke="#333" stroke-width="8" stroke-linecap="round"/><circle cx="42" cy="32" r="3" fill="#333"/><circle cx="58" cy="32" r="3" fill="#333"/><path d="M45 45 Q50 48 55 45" stroke="#333" stroke-width="2" fill="none"/><path d="M15 55 L25 80" stroke="#E0AC69" stroke-width="8" stroke-linecap="round"/><path d="M85 55 L75 80" stroke="#E0AC69" stroke-width="8" stroke-linecap="round"/></g></svg>`
    };

    /* --- CATALOG LOGIC --- */
    function toggleCatalog() {
        const modal = document.getElementById('catalogModal');
        modal.classList.toggle('open');
        if (modal.classList.contains('open')) renderCatalogTabs();
    }

    function renderCatalogTabs() {
        const tabs = document.getElementById('catalogTabs');
        tabs.innerHTML = '';
        Object.keys(CATALOG).forEach((cat, idx) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${idx === 0 ? 'active' : ''}`;
            btn.innerText = cat;
            btn.onclick = (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                renderCatalogGrid(cat);
            };
            tabs.appendChild(btn);
        });
        renderCatalogGrid(Object.keys(CATALOG)[0]);
    }

    function renderCatalogGrid(cat) {
        const grid = document.getElementById('catalogGrid');
        grid.innerHTML = '';
        CATALOG[cat].forEach(item => {
            const div = document.createElement('div');
            div.className = 'catalog-item';
            div.innerHTML = item.svg;
            div.onclick = () => spawnItem(item);
            grid.appendChild(div);
        });
    }

    function spawnItem(itemData) {
        // Create Instance
        const newItem = {
            id: `obj_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,
            scene: state.currentScene,
            x: GAME_WIDTH / 2 - (itemData.w ? itemData.w/2 : 25),
            y: GAME_HEIGHT / 2 - (itemData.h ? itemData.h/2 : 25),
            ...itemData
        };
        delete newItem.svg; // Don't store rendered SVG string, regenerate on load if needed
        
        state.items.push(newItem);
        renderScene();
        saveState();
        
        // Close modal
        document.getElementById('catalogModal').classList.remove('open');
    }


    /* --- RENDER --- */
    function renderScene() {
        const bgContainer = document.getElementById('sceneBackground');
        const objLayer = document.getElementById('objectsLayer');
        
        bgContainer.innerHTML = '';
        objLayer.innerHTML = '';

        // Background
        const sceneDiv = document.createElement('div');
        sceneDiv.className = `scene`;
        const wall = document.createElement('div');
        wall.className = `wall ${state.currentScene}-wall`;
        const floor = document.createElement('div');
        floor.className = `floor ${state.currentScene}-floor`;
        sceneDiv.appendChild(wall);
        sceneDiv.appendChild(floor);
        bgContainer.appendChild(sceneDiv);

        // Light
        const light = document.createElement('div');
        light.className = 'light-overlay';
        light.style.opacity = state.isLightOn ? '0' : '1';
        bgContainer.appendChild(light);

        // Switch
        const switchEl = document.createElement('div');
        switchEl.className = 'wall-switch';
        switchEl.innerHTML = `<div class="wall-switch-knob" style="transform: translateY(${state.isLightOn ? '-5px' : '5px'})"></div>`;
        switchEl.onclick = () => { state.isLightOn = !state.isLightOn; renderScene(); saveState(); };
        bgContainer.appendChild(switchEl);

        // Objects
        state.items.forEach(item => {
            if (item.scene === state.currentScene) createObject(item, objLayer);
        });

        updateNav();
    }

    function createObject(data, parent) {
        const el = document.createElement('div');
        el.className = `game-obj type-${data.type}`;
        el.id = data.id;
        el.style.left = data.x + 'px';
        el.style.top = data.y + 'px';

        if(data.w) el.style.width = data.w + 'px';
        if(data.h) el.style.height = data.h + 'px';

        // Render Content
        if (data.svgTemplate) {
            // It's a furniture with a template and color
            if (data.subtype === 'fridge') {
                el.classList.add('fridge-group');
                if(state.fridgeOpen) el.classList.add('fridge-open');
                el.innerHTML = `<div class="absolute w-full h-full">${SVG_TEMPLATES.fridge(data.color)}</div>
                                <div class="absolute w-full h-full fridge-door cursor-pointer">${SVG_TEMPLATES.fridge(data.color).replace('rx="10" fill="', 'rx="10" fill="#fff" stroke="')}</div>`; // Hacky door gen
                // Use default door for simplicity or regenerate
            } else {
                el.innerHTML = SVG_TEMPLATES[data.svgTemplate](data.color);
            }
        } else if (data.svg && ASSETS_CHAR[data.svg]) {
             el.innerHTML = ASSETS_CHAR[data.svg];
        } else if (data.emoji) {
            el.innerHTML = `<div class="drop-shadow-sm" style="font-size:${data.type==='food'?30:40}px">${data.emoji}</div>`;
        }

        makeDraggable(el, data);
        parent.appendChild(el);
    }

    /* --- DRAG LOGIC --- */
    function makeDraggable(el, dataRef) {
        let isDragging = false;
        let startX, startY, initX, initY;
        let hasMoved = false;

        const start = (e) => {
            if(e.type === 'touchstart') e.preventDefault(); 
            isDragging = true; hasMoved = false;
            const p = e.touches ? e.touches[0] : e;
            startX = p.clientX; startY = p.clientY;
            initX = parseFloat(el.style.left); initY = parseFloat(el.style.top);
            
            document.addEventListener('mousemove', move);
            document.addEventListener('touchmove', move, {passive: false});
            document.addEventListener('mouseup', end);
            document.addEventListener('touchend', end);
            el.style.zIndex = 100; el.style.transition = 'none';
        };

        const move = (e) => {
            if(!isDragging) return;
            e.preventDefault(); hasMoved = true;
            const p = e.touches ? e.touches[0] : e;
            const dx = p.clientX - startX; const dy = p.clientY - startY;
            let nx = Math.max(-50, Math.min(initX + dx, GAME_WIDTH - 20));
            let ny = Math.max(-50, Math.min(initY + dy, GAME_HEIGHT - 20));
            el.style.left = nx + 'px'; el.style.top = ny + 'px';
            dataRef.x = nx; dataRef.y = ny;
        };

        const end = (e) => {
            if(!isDragging) return;
            isDragging = false;
            document.removeEventListener('mousemove', move);
            document.removeEventListener('touchmove', move);
            document.removeEventListener('mouseup', end);
            document.removeEventListener('touchend', end);
            el.style.transition = 'transform 0.1s'; el.style.zIndex = '';
            
            if(hasMoved) { checkCollisions(el, dataRef); saveState(); }
        };
        el.addEventListener('mousedown', start);
        el.addEventListener('touchstart', start, {passive: false});
    }

    function checkCollisions(el, data) {
        if(data.type === 'food') {
            const chars = state.items.filter(i => i.type === 'character' && i.scene === state.currentScene);
            chars.forEach(c => {
                const target = document.getElementById(c.id);
                if(target && isOverlapping(el, target)) eatFood(data, target);
            });
        }
    }

    function isOverlapping(a, b) {
        const r1 = a.getBoundingClientRect(); const r2 = b.getBoundingClientRect(); const pad = 10;
        return !(r1.right-pad < r2.left || r1.left+pad > r2.right || r1.bottom-pad < r2.top || r1.top+pad > r2.bottom);
    }

    function eatFood(food, char) {
        document.getElementById(food.id)?.remove();
        state.items = state.items.filter(i => i.id !== food.id);
        const r = document.createElement('div'); r.innerText = 'üòã'; r.className = 'reaction-emoji';
        const rect = char.getBoundingClientRect(); r.style.left = (rect.left+20)+'px'; r.style.top = (rect.top-50)+'px';
        document.body.appendChild(r);
        char.style.transform = 'scale(1.2)'; setTimeout(() => char.style.transform = 'scale(1)', 200); setTimeout(() => r.remove(), 1000);
        saveState();
    }

    /* --- API & UTILS --- */
    async function callGemini(prompt) {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json(); return data.candidates?.[0]?.content?.parts?.[0]?.text;
        } catch (e) { console.error(e); return null; }
    }

    async function generateScenario() {
        const btn = document.getElementById('btnScenario');
        const orig = btn.innerHTML; btn.innerHTML = '‚ú® ...'; btn.disabled = true;
        const local = state.items.filter(i => i.scene === state.currentScene);
        const context = { scene: state.currentScene, chars: local.filter(i => i.type==='character').length, items: local.length };
        const prompt = `Kids dollhouse game. Scene: ${context.scene}. ${context.chars} chars, ${context.items} items. Fun 1 sentence task.`;
        const text = await callGemini(prompt);
        btn.innerHTML = orig; btn.disabled = false;
        if(text) { document.getElementById('scenarioText').innerText = text; document.getElementById('scenarioBox').style.display = 'block'; }
    }

    async function generateThoughts() {
        const chars = state.items.filter(i => i.type === 'character' && i.scene === state.currentScene);
        if(!chars.length) return alert("Add a character first!");
        const btn = document.getElementById('btnThoughts'); const orig = btn.innerHTML; btn.innerHTML = 'üí≠ ...'; btn.disabled = true;
        const text = await callGemini(`Funny thought for dollhouse character in ${state.currentScene}. Max 6 words.`);
        btn.innerHTML = orig; btn.disabled = false;
        if(text) {
            const char = chars[Math.floor(Math.random() * chars.length)];
            const el = document.getElementById(char.id);
            if(el) {
                const b = document.createElement('div'); b.className = 'speech-bubble'; b.innerText = text;
                document.getElementById('gameContainer').appendChild(b);
                const rect = el.getBoundingClientRect(); b.style.left = (rect.left+10)+'px'; b.style.top = (rect.top-80)+'px';
                setTimeout(() => b.remove(), 4000);
            }
        }
    }

    function switchScene(s) { state.currentScene = s; renderScene(); saveState(); }
    function updateNav() { document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.getElementById(`btn-${state.currentScene}`).classList.add('active'); }
    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); document.getElementById('saveToast').style.opacity=1; setTimeout(()=>document.getElementById('saveToast').style.opacity=0, 1000); }
    function loadState() { const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : null; }
    function resetGame() { if(confirm("Clear world?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }

    window.addEventListener('resize', () => {});
    renderScene();

</script>
</body>
</html>
